---
import type { Language } from '@lib/i18n';
import { getLocalizedPath } from '@lib/i18n';

interface Props {
  currentLang: Language;
  currentPath: string;
}

const { currentLang, currentPath } = Astro.props;

const languages: { code: Language; name: string; short: string }[] = [
  { code: 'en', name: 'English', short: 'EN' },
  { code: 'fi', name: 'Suomi', short: 'FI' },
  { code: 'sv', name: 'Svenska', short: 'SV' },
];

const currentLanguage = languages.find(lang => lang.code === currentLang) || languages[0];
const currentPathClean = currentPath || '/';
---

<nav aria-label="Language selector" class="language-switcher relative hidden">
  <div class="relative">
    <button
      type="button"
      class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm transition-colors bg-white border border-gray-200 hover:border-[#2841CF] text-black"
      id="language-button"
      aria-expanded="false"
      aria-haspopup="true"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"
        />
      </svg>
      <span>{currentLanguage.short}</span>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-3 w-3"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    <div
      class="hidden absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50"
      id="language-dropdown"
      role="menu"
      aria-orientation="vertical"
    >
      {languages.map((lang) => (
        <button
          type="button"
          data-lang={lang.code}
          class={`block w-full text-left px-4 py-2 text-sm transition-colors ${
            currentLang === lang.code
              ? 'bg-[#2841CF] text-white'
              : 'text-black hover:bg-[#F6F7FB]'
          }`}
          role="menuitem"
        >
          {lang.name}
        </button>
      ))}
    </div>
  </div>
</nav>

<script>
  const button = document.getElementById('language-button');
  const dropdown = document.getElementById('language-dropdown');

  if (button && dropdown) {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const isExpanded = button.getAttribute('aria-expanded') === 'true';
      dropdown.classList.toggle('hidden', isExpanded);
      button.setAttribute('aria-expanded', String(!isExpanded));
    });

    // Handle language selection
    dropdown.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const langButton = target.closest('button[data-lang]');
      if (langButton) {
        const newLang = langButton.getAttribute('data-lang');
        if (newLang) {
          // Get current path and convert to new language path
          const currentPath = window.location.pathname;
          const pathMappings: Record<string, Record<string, string>> = {
            '/': { en: '/', fi: '/', sv: '/' },
            '/programs': { en: '/programs', fi: '/ohjelmat', sv: '/program' },
            '/resources': { en: '/resources', fi: '/resurssit', sv: '/resurser' },
            '/integrations': { en: '/integrations', fi: '/integraatiot', sv: '/integrationer' },
            '/start': { en: '/start', fi: '/aloita', sv: '/starta' },
            '/contact': { en: '/contact', fi: '/yhteystiedot', sv: '/kontakt' },
            '/privacy': { en: '/privacy', fi: '/tietosuoja', sv: '/integritet' },
            '/search': { en: '/search', fi: '/haku', sv: '/sok' },
          };
          
          // Find base path
          let basePath = '/';
          let suffix = '';
          for (const [base, langs] of Object.entries(pathMappings)) {
            if (currentPath === base || currentPath.startsWith(base + '/')) {
              basePath = base;
              suffix = currentPath.slice(base.length);
              break;
            }
          }
          
          // Get localized path for new language
          const newPath = pathMappings[basePath]?.[newLang] || basePath;
          const fullNewPath = newPath + suffix;
          
          // Set cookie and navigate
          document.cookie = `lang=${newLang};path=/;max-age=31536000;SameSite=Lax`;
          window.location.href = fullNewPath;
        }
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as Node | null;
      if (target && !button.contains(target) && !dropdown.contains(target)) {
        dropdown.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
      }
    });
  }
</script>
