---
import type { Resource, Category } from '@lib/supabase';
import { truncate } from '@lib/utils';
import type { Language } from '@lib/i18n';

interface Props {
  resource: Resource;
  lang: Language;
  category?: Category | null;
  hideCategory?: boolean;
  titleOverlay?: boolean;
  homepageStyle?: boolean;
}

const { resource, lang, category, hideCategory = false, titleOverlay = false, homepageStyle = false } = Astro.props;

// Split title into lines for overlay (max 2 lines, roughly equal word distribution)
const splitTitleIntoLines = (title: string): string[] => {
  const words = title.split(' ');
  if (words.length <= 1) return [title];
  
  const midPoint = Math.ceil(words.length / 2);
  const firstLine = words.slice(0, midPoint).join(' ');
  const secondLine = words.slice(midPoint).join(' ');
  
  return [firstLine, secondLine].filter(line => line.length > 0);
};
---

<div
  class={`block h-full flex flex-col ${homepageStyle ? 'bg-gray-50 rounded-[25px] p-6' : 'card'}`}
  data-testid="resource-card"
>
  {resource.cover_image_url ? (
    <a href={`/${resource.slug}`} class="block relative mb-4 flex-shrink-0">
      <img
        src={resource.cover_image_url}
        alt={resource.title}
        class="w-full h-48 object-cover rounded-lg transition-opacity hover:opacity-80"
        loading="lazy"
        width="400"
        height="192"
        decoding="async"
      />
      {titleOverlay && (
        <div class="absolute bottom-0 left-0 p-4 m-3 flex flex-col gap-2 items-start">
          {splitTitleIntoLines(resource.title).map((line, index) => (
            <span 
              class={`inline-block px-3 py-1.5 rounded-lg bg-black/70 backdrop-blur-sm text-white font-bold text-lg ${index > 0 ? 'ml-4' : ''}`}
            >
              {line}
            </span>
          ))}
        </div>
      )}
    </a>
  ) : (
    titleOverlay && (
      <a href={`/${resource.slug}`} class="block mb-4">
        <div class="w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center p-4 m-3">
          <div class="bg-black/70 backdrop-blur-sm rounded-lg p-4 w-full">
            <h3 class="text-xl font-bold text-white">{resource.title}</h3>
          </div>
        </div>
      </a>
    )
  )}
  {category && !hideCategory && (
    <a
      href={`/resources/${category.slug}`}
      class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm transition-colors bg-white border border-gray-200 hover:border-[#2841CF] text-black mb-2 block flex-shrink-0"
    >
      {category[`name_${lang}` as keyof Category] || category.name_en}
    </a>
  )}
  {!titleOverlay && (
    <a href={`/${resource.slug}`} class="block transition-opacity hover:opacity-80 flex-grow flex flex-col">
      <h3 class="text-xl font-bold mb-2 flex-shrink-0">{resource.title}</h3>
      {resource.excerpt && (
        <p class="text-black mb-4 flex-grow">{truncate(resource.excerpt, 150)}</p>
      )}
    </a>
  )}
  {titleOverlay && resource.excerpt && (
    <a href={`/${resource.slug}`} class="block transition-opacity hover:opacity-80 flex-grow">
      <p class="text-black mb-4 flex-grow">{truncate(resource.excerpt, 150)}</p>
    </a>
  )}
</div>

