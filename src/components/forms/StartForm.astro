---
import { getTranslations, getLocalizedPath, type Language } from '@lib/i18n';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;
const t = getTranslations(lang);
const privacyPath = getLocalizedPath('/privacy', lang);

// Category options
const categoryOptions = [
  'Mentoring Program',
  'Coaching Program',
  'Networking Program',
  'Training Program',
  'Onboarding Program',
  'Employee Wellbeing Program',
  'ERG Program',
  'Leadership Program',
  'Career Management Program',
  'Career Program',
  'Internship Program',
  'Accelerator Program',
  'Incubator Program',
  'Fundraising Support Program',
  'Business Development Program',
  'Volunteer Program',
  'Ambassador Program',
  'Other'
];

// Audience options
const audienceOptions = [
  'Community Members',
  'Employees',
  'Entrepreneurs & Startups',
  'Professionals',
  'University Students',
  'Women',
  'Other'
];
---

<div style="min-height: 500px;">
<form
  id="start-form"
  class="space-y-6"
  data-testid="start-form"
>
  <div>
    <input
      type="text"
      id="name"
      name="name"
      placeholder={t.forms.start.name}
      required
      class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
    />
  </div>

  <div>
    <input
      type="email"
      id="email"
      name="email"
      placeholder={t.forms.start.email}
      required
      class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
    />
  </div>

  <div>
    <input
      type="text"
      id="organization"
      name="organization"
      placeholder={t.forms.start.organization}
      required
      class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
    />
  </div>

  <div>
    <select
      id="category"
      name="category"
      required
      class="w-full px-4 py-2 pr-10 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent appearance-none"
      style="background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E\"); background-repeat: no-repeat; background-position: right 0.75rem center;"
    >
      <option value="">Category</option>
      {categoryOptions.map((option) => (
        <option value={option}>{option}</option>
      ))}
    </select>
  </div>

  <div>
    <select
      id="audience"
      name="audience"
      required
      class="w-full px-4 py-2 pr-10 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent appearance-none"
      style="background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E\"); background-repeat: no-repeat; background-position: right 0.75rem center;"
    >
      <option value="">Audience</option>
      {audienceOptions.map((option) => (
        <option value={option}>{option}</option>
      ))}
    </select>
  </div>

  <div>
    <textarea
      id="needs"
      name="needs"
      rows="6"
      placeholder={t.forms.start.needs}
      required
      class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
    ></textarea>
  </div>

  <button
    type="submit"
    class="btn btn-primary w-full"
  >
    {t.forms.start.submit}
  </button>

  <p class="text-sm text-gray-600 text-center" set:html={t.forms.start.privacyNotice.replace('{privacyPolicy}', `<a href="${privacyPath}" class="font-bold">${t.forms.start.privacyPolicy}</a>`)}></p>

  <div id="form-message" class="hidden text-center"></div>
</form>

<div id="form-success" class="hidden text-center py-8">
  <h3 class="text-2xl font-bold mb-2">{t.forms.start.successTitle}</h3>
  <p class="text-gray-600">{t.forms.start.successMessage}</p>
</div>
</div>

<script>
  const form = document.getElementById('start-form') as HTMLFormElement;
  const messageDiv = document.getElementById('form-message') as HTMLDivElement;
  const successDiv = document.getElementById('form-success') as HTMLDivElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const data = {
      type: 'start',
      name: formData.get('name'),
      email: formData.get('email'),
      organization: formData.get('organization'),
      category: formData.get('category'),
      audience: formData.get('audience'),
      needs: formData.get('needs'),
      page_url: window.location.href,
    };

    try {
      const response = await fetch('/api/form', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        form.style.display = 'none';
        successDiv.classList.remove('hidden');
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        console.error('Form submission failed:', response.status, errorData);
        throw new Error(errorData.error || 'Form submission failed');
      }
    } catch (error) {
      console.error('Form error:', error);
      messageDiv.className = 'block text-red-600 font-semibold';
      messageDiv.textContent = error instanceof Error ? error.message : 'An error occurred';
    }
  });
</script>
