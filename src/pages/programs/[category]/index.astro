---
import PageLayout from '@layouts/PageLayout.astro';
import ContentLayout from '@layouts/ContentLayout.astro';
import ProgramCard from '@components/programs/ProgramCard.astro';
import { supabase, type Program, type Category } from '@lib/supabase';
import { getTranslations, getLocalizedPath, type Language, getLanguageFromCookie } from '@lib/i18n';
import { marked } from 'marked';
import { slugify } from '@lib/utils';

export const prerender = false; // Edge SSR

const lang = getLanguageFromCookie(Astro.cookies, Astro.url) || 'en';
const categorySlug = Astro.params.category || '';
const t = getTranslations(lang);

let programs: Program[] = [];
let category: Category | null = null;
let categories: Category[] = [];
let categoryMap: Map<string, Category> = new Map();
let uniqueAudiences: string[] = [];
let programForSlug: Program | null = null;
let programCategory: Category | null = null;
let relatedPrograms: Program[] = [];

try {
  // First check if this is actually a program slug, not a category
  // If it's a program slug, we need to redirect since [category] route matches first
  const { data: allProgramsCheck } = await supabase
    .from('programs')
    .select('*');
  
  if (allProgramsCheck && allProgramsCheck.length > 0) {
    const normalizedCategorySlug = categorySlug.toLowerCase().trim();
    if (import.meta.env.DEV) {
      console.log('[Category Route] Checking for program slug:', normalizedCategorySlug);
      console.log('[Category Route] Found programs:', allProgramsCheck.length);
      console.log('[Category Route] First few slugs:', allProgramsCheck.slice(0, 3).map(p => p.slug));
    }
    programForSlug = allProgramsCheck.find(p => {
      const programSlug = (p.slug || '').toLowerCase().trim();
      return programSlug === normalizedCategorySlug;
    }) || null;
    if (import.meta.env.DEV) {
      console.log('[Category Route] Program found:', programForSlug ? programForSlug.title : 'Not found');
    }
  }
  
  // If this is a program slug, get category and related programs
  if (programForSlug) {
    if (programForSlug.category) {
      // Try to fetch by ID first (category.id is TEXT, e.g., "mentoring-program")
      let categoryData = null;
      const { data: dataById } = await supabase
        .from('categories')
        .select('*')
        .eq('id', programForSlug.category)
        .eq('type', 'program')
        .maybeSingle();
      
      if (dataById) {
        categoryData = dataById;
      } else {
        // If ID lookup fails, try by slug
        const { data: dataBySlug } = await supabase
          .from('categories')
          .select('*')
          .eq('slug', programForSlug.category)
          .eq('type', 'program')
          .maybeSingle();
        
        if (dataBySlug) {
          categoryData = dataBySlug;
        } else {
          // If slug lookup fails, try by name_en (category name might be stored)
          const { data: dataByNameEn } = await supabase
            .from('categories')
            .select('*')
            .eq('name_en', programForSlug.category)
            .eq('type', 'program')
            .maybeSingle();
          
          if (dataByNameEn) {
            categoryData = dataByNameEn;
          } else {
            // Try name_fi and name_sv as well
            const { data: dataByNameFi } = await supabase
              .from('categories')
              .select('*')
              .eq('name_fi', programForSlug.category)
              .eq('type', 'program')
              .maybeSingle();
            
            if (dataByNameFi) {
              categoryData = dataByNameFi;
            } else {
              const { data: dataByNameSv } = await supabase
                .from('categories')
                .select('*')
                .eq('name_sv', programForSlug.category)
                .eq('type', 'program')
                .maybeSingle();
              
              if (dataByNameSv) {
                categoryData = dataByNameSv;
              }
            }
          }
        }
      }
      
      programCategory = categoryData || null;
    }

    if (programCategory) {
      try {
        // Try multiple category matching strategies
        const { data: relatedDataById } = await supabase
          .from('programs')
          .select('*')
          .eq('language', lang)
          .eq('is_published', true)
          .eq('category', programCategory.id)
          .neq('id', programForSlug.id)
          .order('published_at', { ascending: false })
          .limit(10);
        
        if (relatedDataById && relatedDataById.length > 0) {
          relatedPrograms = relatedDataById;
        } else {
          // If ID match fails, try by slug
          const { data: relatedDataBySlug } = await supabase
            .from('programs')
            .select('*')
            .eq('language', lang)
            .eq('is_published', true)
            .eq('category', programCategory.slug)
            .neq('id', programForSlug.id)
            .order('published_at', { ascending: false })
            .limit(10);
          
          if (relatedDataBySlug && relatedDataBySlug.length > 0) {
            relatedPrograms = relatedDataBySlug;
          } else {
            // If slug match fails, try by name_en
            const { data: relatedDataByName } = await supabase
              .from('programs')
              .select('*')
              .eq('language', lang)
              .eq('is_published', true)
              .eq('category', programCategory.name_en)
              .neq('id', programForSlug.id)
              .order('published_at', { ascending: false })
              .limit(10);
            
            relatedPrograms = relatedDataByName || [];
          }
        }
        
        if (import.meta.env.DEV) {
          console.log('[Category Route] Related programs fetched:', relatedPrograms.length, 'for category:', programCategory.id, 'programCategory:', programCategory);
        }
      } catch (error) {
        console.error('Error fetching related programs:', error);
        relatedPrograms = [];
      }
    }
  }
  
  // Get category info
  const { data: categoryData } = await supabase
    .from('categories')
    .select('*')
    .eq('type', 'program')
    .eq('slug', categorySlug)
    .maybeSingle();

  category = categoryData;
} catch (error) {
  console.error('Error in category route:', error);
}

// If category not found AND it's not a program slug, return 404
if (!category && !programForSlug) {
  return new Response(null, { status: 404 });
}

try {
  // Get all categories for navigation
  const { data: categoriesData } = await supabase
    .from('categories')
    .select('*')
    .eq('type', 'program')
    .order('sort_order', { ascending: true });

  categories = categoriesData || [];
  
  // Create category map for quick lookup
  categories.forEach((cat) => {
    categoryMap.set(cat.id, cat);
    categoryMap.set(cat.slug, cat);
    categoryMap.set(cat.name_en, cat);
  });

  if (category) {
    // Get all published programs for this language
    const { data: allProgramsData } = await supabase
      .from('programs')
      .select('*')
      .eq('language', lang)
      .eq('is_published', true)
      .order('published_at', { ascending: false });

    if (allProgramsData) {
      // Filter programs by category (try multiple matching strategies)
      programs = allProgramsData.filter((program) => {
        if (!program.category) return false;
        
        // Try direct ID match
        if (program.category === category.id) return true;
        
        // Try slug match
        if (program.category === category.slug) return true;
        
        // Try name_en match
        if (program.category === category.name_en) return true;
        
        // Try name_fi and name_sv matches
        if (program.category === category.name_fi || program.category === category.name_sv) return true;
        
        // Try reverse lookup through categoryMap
        const programCategory = categoryMap.get(program.category);
        if (programCategory && programCategory.id === category.id) return true;
        
        return false;
      }).slice(0, 20);
      
      // Extract unique audiences from filtered programs
      const audiences = new Set<string>();
      programs.forEach((program) => {
        if (program.audience && program.audience.trim()) {
          audiences.add(program.audience.trim());
        }
      });
      uniqueAudiences = Array.from(audiences).sort();
    }
  }
} catch (error) {
  console.error('Error fetching category programs:', error);
}

// Don't redirect if it's a program slug
if (!category && !programForSlug) {
  return new Response(null, { status: 404 });
}

const categoryName = category ? (category[`name_${lang}` as keyof Category] || category.name_en) : '';
const categoryDescription = category ? ((category[`description_${lang}` as keyof Category] || category.description_en) as string | undefined) : undefined;
const canonicalProgram = programForSlug ? `https://plademy.com/programs/${programForSlug.slug}` : undefined;

let relatedProgramsLabel: string | undefined = undefined;
if (programCategory) {
  const programCategoryName = String(programCategory[`name_${lang}` as keyof Category] || programCategory.name_en);
  const baseLabel = t.programs.relatedProgramsInterest || 'You might be interested in programs';
  relatedProgramsLabel = baseLabel.replace('{category}', programCategoryName);
}

// Form description - moved from IIFE to frontmatter
let formDescription: string = 'AI Powered Mentoring, Coaching, Community Management and Training Platforms';
if (programForSlug || category) {
  const activeCategory = programForSlug ? programCategory : category;
  if (activeCategory) {
    const categoryName = activeCategory[`name_${lang}` as keyof Category] || activeCategory.name_en;
    formDescription = `AI Powered Solutions For Your ${categoryName}.`;
  }
}

// Process programForSlug content - moved from IIFE to frontmatter
let processedContent: string | null = null;
if (programForSlug && programForSlug.content) {
  // Clean up malformed checkmark patterns - catch ALL variations of $render with checkmark
  const cleanedContent = programForSlug.content
    .replace(/\$render[^✓]*✓[^<]*/g, '✓')
    .replace(/\$render[^✓]*✓[^<]*/g, '✓') // Run twice to catch nested patterns
    .replace(/`✓`/g, '✓')
    .replace(/\$render/g, '') // Remove any remaining $render without checkmark
    .replace(/\\`✓\\`/g, '✓')
    .replace(/\\`/g, '');
  
  const parsedContent = marked.parse(cleanedContent) as string;
  processedContent = parsedContent
    // Replace any $render pattern with checkmark - multiple passes for reliability
    .replace(/\$render[^✓]*✓[^<]*/g, '✓')
    .replace(/\$render[^✓]*✓[^<]*/g, '✓') // Second pass
    // Handle HTML entities and encoded characters
    .replace(/\$render[^✓]*✓[^<]*/g, '✓')
    // Replace in any HTML tag content
    .replace(/>([^<]*)\$render[^✓]*✓[^<]*(<)/g, (match, before, after) => {
      return `>${before.replace(/\$render[^✓]*✓[^<]*/g, '✓')}${after}`;
    })
    // Handle list items specifically - more aggressive
    .replace(/<li([^>]*)>([^<]*)\$render[^✓]*✓[^<]*/gi, '<li$1>✓$2')
    .replace(/<li([^>]*)>([^<]*)\$render[^✓]*✓[^<]*/gi, '<li$1>✓$2') // Second pass
    // Remove any remaining $render
    .replace(/\$render/g, '')
    .replace(/<h3([^>]*)>(.*?)<\/h3>/gi, (_match: string, attrs: string, text: string) => {
      const id = slugify(text.replace(/<[^>]*>/g, ''));
      return `<h3${attrs} id="${id}">${text}</h3>`;
    })
    .replace(/<input[^>]*type=["']checkbox["'][^>]*>/gi, '<span class="text-primary mr-2">✓</span>')
    .replace(/<ol([^>]*)>/gi, '<ol$1 style="padding: 30px 30px 30px 80px !important; background-color: #f6f7fb !important; border-radius: 20px !important; list-style-position: outside !important;">')
    .replace(/<ul([^>]*)>/gi, '<ul$1 style="padding: 30px 30px 30px 80px !important; background-color: #f6f7fb !important; border-radius: 20px !important; list-style-position: outside !important;">');
}
---

{programForSlug ? (
  <ContentLayout
    title={programForSlug.title}
    description={programForSlug.description || programForSlug.excerpt || undefined}
    image={programForSlug.cover_image_url || undefined}
    lang={lang}
    publishedTime={programForSlug.published_at}
    canonical={canonicalProgram}
    relatedPrograms={relatedPrograms}
    relatedProgramsLabel={relatedProgramsLabel}
    programGoal={programForSlug.goal || undefined}
    programDuration={programForSlug.duration || undefined}
    programAudience={programForSlug.audience || undefined}
  >
    <div slot="after-description">
      {programCategory && (
        <div class="mb-6">
          <a
            href={`/programs/${programCategory.slug}`}
            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-white border border-gray-200 text-black hover:opacity-80 transition-opacity"
          >
            {String(programCategory[`name_${lang}` as keyof Category] || programCategory.name_en)}
          </a>
        </div>
      )}
    </div>

    {programForSlug.cover_image_url && (
      <img
        src={programForSlug.cover_image_url}
        alt={programForSlug.title}
        class="w-full h-96 object-cover rounded-3xl mb-8"
        loading="eager"
      />
    )}

    {programForSlug.keypoints && programForSlug.keypoints.length > 0 && (
      <div class="bg-blue-50 rounded-3xl p-12 mb-8">
        <h2 class="text-2xl font-bold mb-4">Key Points</h2>
        <ul class="space-y-4 keypoints-list">
          {programForSlug.keypoints.map((point) => (
            <li class="flex items-start">
              <span class="text-primary mr-2">✓</span>
              <span>{point}</span>
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- Resource Form (After Keypoints) -->
    <div class="card mb-8 p-8 md:p-12" id="resource-form-container" style="min-height: 200px;">
      <form
        id="resource-form"
        name="resource form"
        class="grid md:grid-cols-2 gap-8 items-center"
      >
        <div>
          <h3 class="text-2xl font-bold mb-3">
            {t.programs.formTitle || 'Start implementing this program today'}
          </h3>
          <p class="text-black">
            {formDescription}
          </p>
        </div>
        <div class="space-y-4">
          <div>
            <input
              type="text"
              id="resource-form-name"
              name="name"
              placeholder="Full Name"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
            />
          </div>
          <div>
            <input
              type="email"
              id="resource-form-email"
              name="email"
              placeholder="Email"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
            />
          </div>
          <button
            type="submit"
            class="btn btn-primary w-full"
          >
            Get Started For Free
          </button>
          <p class="!text-[10px] text-gray-600 md:col-span-2 not-prose" set:html={t.forms.program.privacyNotice.replace('{privacyPolicy}', `<a href="${getLocalizedPath('/privacy', lang)}" class="font-bold">${t.forms.program.privacyPolicy}</a>`)}></p>
        </div>
      </form>
      <div id="resource-form-success" class="hidden text-center py-8">
        <h3 class="text-2xl font-bold mb-2">{t.forms.program.successTitle}</h3>
        <p class="text-gray-600">{t.forms.program.successMessage}</p>
      </div>
      <div id="resource-form-message" class="hidden text-center mt-4"></div>
    </div>

    {processedContent && (
      <div 
        class="prose prose-lg max-w-none content-prose"
        set:html={processedContent}
      />
    )}

    {programForSlug.faqs && Array.isArray(programForSlug.faqs) && programForSlug.faqs.length > 0 && (
      <div id="frequently-asked-questions" class="mt-12">
        <h2 class="text-3xl font-bold mb-6">Frequently Asked Questions</h2>
        <div class="space-y-4">
          {programForSlug.faqs.map((faq: any, index: number) => (
            <div class="rounded-3xl overflow-hidden faq-item hover:border-black transition-colors border border-gray-200 bg-white" data-faq-item={index}>
              <button
                class="w-full text-left flex items-center justify-between py-[15px] px-6 faq-toggle"
                data-faq-index={index}
                aria-expanded="false"
              >
                <h3 class="text-xl font-bold pr-4">{faq.question}</h3>
                <svg
                  class="w-5 h-5 text-gray-500 flex-shrink-0 faq-icon transition-transform"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div class="faq-content max-h-0 overflow-hidden transition-all duration-300 ease-in-out" data-faq-content={index}>
                <div class="px-6 pb-6 text-black">
                  <p>{faq.answer}</p>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Resource Form (Bottom) -->
    <div class="card mb-8 p-8 md:p-12 mt-12" id="resource-form-bottom-container" style="min-height: 200px;">
      <form
        id="resource-form-bottom"
        name="resource form"
        class="grid md:grid-cols-2 gap-8 items-center"
      >
        <div>
          <h3 class="text-2xl font-bold mb-3">
            {t.programs.formTitle || 'Start implementing this program today'}
          </h3>
          <p class="text-black">
            {formDescription}
          </p>
        </div>
        <div class="space-y-4">
          <div>
            <input
              type="text"
              id="resource-form-bottom-name"
              name="name"
              placeholder="Full Name"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
            />
          </div>
          <div>
            <input
              type="email"
              id="resource-form-bottom-email"
              name="email"
              placeholder="Email"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
            />
          </div>
          <button
            type="submit"
            class="btn btn-primary w-full"
          >
            Get Started For Free
          </button>
          <p class="!text-[10px] text-gray-600 md:col-span-2 not-prose" set:html={t.forms.program.privacyNotice.replace('{privacyPolicy}', `<a href="${getLocalizedPath('/privacy', lang)}" class="font-bold">${t.forms.program.privacyPolicy}</a>`)}></p>
        </div>
      </form>
      <div id="resource-form-bottom-success" class="hidden text-center py-8">
        <h3 class="text-2xl font-bold mb-2">{t.forms.program.successTitle}</h3>
        <p class="text-gray-600">{t.forms.program.successMessage}</p>
      </div>
      <div id="resource-form-bottom-message" class="hidden text-center mt-4"></div>
    </div>

    <div class="mt-8 pt-8 border-t">
      <a href="/programs/" class="text-primary hover:underline">
        ← {t.common.back} to Programs
      </a>
    </div>
  </ContentLayout>
) : (

<PageLayout
  title={`${categoryName} - ${t.programs.title}`}
  description={categoryDescription || t.programs.description}
  lang={lang}
>
  <div class="container py-12">
    <div class="mb-8">
      <a href="/programs/" class="text-primary hover:underline mb-4 inline-block">
        ← {t.common.back}
      </a>
      <h1 class="text-4xl font-bold mb-4">{categoryName}</h1>
      {categoryDescription && (
        <p class="text-xl text-black">{categoryDescription}</p>
      )}
    </div>

    <!-- Filters Section -->
    <div class="mb-8 space-y-6">
      <!-- Category Filter (Buttons) -->
      {categories.length > 0 && (
        <div>
          <div class="flex flex-wrap gap-2">
            <a
              href="/programs/"
              class="px-4 py-2 bg-[#F6F7FB] text-black rounded-full hover:opacity-80 transition-colors"
            >
              {t.programs.allPrograms}
            </a>
            {categories.map((cat) => {
              const catName = cat[`name_${lang}` as keyof Category] || cat.name_en;
              const isActive = cat.id === category!.id;
              return (
                <a
                  href={`/programs/${cat.slug}`}
                  class={`px-4 py-2 rounded-full transition-colors ${
                    isActive
                      ? 'bg-[#2841CF] text-white'
                      : 'bg-[#F6F7FB] text-black hover:opacity-80'
                  }`}
                >
                  {catName}
                </a>
              );
            })}
          </div>
        </div>
      )}

      <!-- Audience Filter (Chips) -->
      {uniqueAudiences.length > 0 && (
        <div>
          <div class="flex flex-wrap gap-2">
            <button
              data-filter="audience"
              data-value=""
              class="filter-chip px-4 py-2 bg-[#F6F7FB] text-black rounded-full hover:opacity-80 transition-colors"
            >
              {t.programs.allAudiences || 'All Audiences'}
            </button>
            {uniqueAudiences.map((audience) => (
              <button
                data-filter="audience"
                data-value={audience}
                class="filter-chip px-4 py-2 bg-[#F6F7FB] text-black rounded-full hover:opacity-80 transition-colors"
              >
                {audience}
              </button>
            ))}
          </div>
        </div>
      )}

      <!-- Goal Search Filter -->
      <div>
        <input
          type="text"
          id="goal-search"
          placeholder={t.programs.searchGoalPlaceholder || 'Type to search program goals...'}
          class="w-full px-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent bg-white"
        />
      </div>
    </div>

    <!-- Programs Grid -->
    <div id="programs-container">
      {programs.length > 0 ? (
        <div class="grid md:grid-cols-3 gap-6" id="programs-grid">
          {programs.map((program) => {
            // Find category for program
            let programCategory: Category | null = null;
            if (program.category) {
              // Try multiple lookup methods
              programCategory = categoryMap.get(program.category) || null;
              if (!programCategory) {
                for (const cat of categories) {
                  if (cat.id === program.category || 
                      cat.slug === program.category || 
                      cat.name_en === program.category ||
                      cat.name_fi === program.category ||
                      cat.name_sv === program.category) {
                    programCategory = cat;
                    break;
                  }
                }
              }
            }
            return (
              <div
                class="program-item h-full"
                data-audience={program.audience || ''}
                data-goal={program.goal || ''}
              >
                <ProgramCard program={program} lang={lang} category={programCategory} />
              </div>
            );
          })}
        </div>
      ) : (
        <p class="text-center text-gray-500 py-12">{t.programs.noPrograms}</p>
      )}

      <!-- No Results Message -->
      <div id="no-results" class="hidden text-center text-gray-500 py-12">
        {t.programs.noPrograms}
      </div>
    </div>

    {!programForSlug && programs.length === 0 && (
      <p class="text-center text-gray-500 py-12">{t.programs.noPrograms}</p>
    )}

    <!-- Resource Form (After Programs List) -->
    {!programForSlug && category && (
      <div class="card mb-8 p-8 md:p-12 mt-12" id="resource-form-container" style="min-height: 200px;">
        <form
          id="resource-form"
          name="resource form"
          class="grid md:grid-cols-2 gap-8 items-center"
        >
          <div>
            <h3 class="text-2xl font-bold mb-3">
              {t.programs.formTitle || 'Start implementing this program today'}
            </h3>
            <p class="text-black">
              {(() => {
                if (!category) return 'AI Powered Mentoring, Coaching, Community Management and Training Platforms';
                const categoryName = category[`name_${lang}` as keyof Category] || category.name_en;
                return `AI Powered Solutions For Your ${categoryName}.`;
              })()}
            </p>
          </div>
          <div class="space-y-4">
            <div>
              <input
                type="text"
                id="resource-form-name"
                name="name"
                placeholder="Full Name"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
              />
            </div>
            <div>
              <input
                type="email"
                id="resource-form-email"
                name="email"
                placeholder="Email"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
              />
            </div>
            <button
              type="submit"
              class="btn btn-primary w-full"
            >
              Get Started For Free
            </button>
            <p class="!text-[10px] text-gray-600 md:col-span-2 not-prose" set:html={t.forms.program.privacyNotice.replace('{privacyPolicy}', `<a href="${getLocalizedPath('/privacy', lang)}" class="font-bold">${t.forms.program.privacyPolicy}</a>`)}></p>
          </div>
        </form>
        <div id="resource-form-success" class="hidden text-center py-8">
          <h3 class="text-2xl font-bold mb-2">{t.forms.program.successTitle}</h3>
          <p class="text-gray-600">{t.forms.program.successMessage}</p>
        </div>
        <div id="resource-form-message" class="hidden text-center mt-4"></div>
      </div>
    )}

    <!-- Resource Form (Bottom) -->
    {!programForSlug && category && (
      <div class="card mb-8 p-8 md:p-12 mt-12" id="resource-form-bottom-container" style="min-height: 200px;">
        <form
          id="resource-form-bottom"
          name="resource form"
          class="grid md:grid-cols-2 gap-8 items-center"
        >
          <div>
            <h3 class="text-2xl font-bold mb-3">
              {t.programs.formTitle || 'Start implementing this program today'}
            </h3>
            <p class="text-black">
              {(() => {
                if (!category) return 'AI Powered Mentoring, Coaching, Community Management and Training Platforms';
                const categoryName = category[`name_${lang}` as keyof Category] || category.name_en;
                return `AI Powered Solutions For Your ${categoryName}.`;
              })()}
            </p>
          </div>
          <div class="space-y-4">
            <div>
              <input
                type="text"
                id="resource-form-bottom-name"
                name="name"
                placeholder="Full Name"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
              />
            </div>
            <div>
              <input
                type="email"
                id="resource-form-bottom-email"
                name="email"
                placeholder="Email"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
              />
            </div>
            <button
              type="submit"
              class="btn btn-primary w-full"
            >
              Get Started For Free
            </button>
            <p class="!text-[10px] text-gray-600 md:col-span-2 not-prose" set:html={t.forms.program.privacyNotice.replace('{privacyPolicy}', `<a href="${getLocalizedPath('/privacy', lang)}" class="font-bold">${t.forms.program.privacyPolicy}</a>`)}></p>
          </div>
        </form>
        <div id="resource-form-bottom-success" class="hidden text-center py-8">
          <h3 class="text-2xl font-bold mb-2">{t.forms.program.successTitle}</h3>
          <p class="text-gray-600">{t.forms.program.successMessage}</p>
        </div>
        <div id="resource-form-bottom-message" class="hidden text-center mt-4"></div>
      </div>
    )}
  </div>
</PageLayout>
)}

{!programForSlug && (
  <script is:inline>
    (function() {
      function initFilters() {
        const filterChips = document.querySelectorAll('.filter-chip');
        const goalSearch = document.getElementById('goal-search');
        const programsGrid = document.getElementById('programs-grid');
        const noResults = document.getElementById('no-results');
        const programItems = document.querySelectorAll('.program-item');

        if (!programItems || programItems.length === 0) {
          console.warn('No program items found');
          return;
        }

        let currentFilters = {
          audience: '',
          goalSearch: ''
        };

        // Fuzzy search function for goal matching
        function fuzzyMatch(text, searchTerm) {
          if (!searchTerm || !text) return true;
          
          const normalizedText = text.toLowerCase().trim();
          const normalizedSearch = searchTerm.toLowerCase().trim();
          
          // Exact match
          if (normalizedText.includes(normalizedSearch)) return true;
          
          // Word-by-word match (all words must be present)
          const searchWords = normalizedSearch.split(/\s+/).filter(w => w.length > 0);
          if (searchWords.length === 0) return true;
          
          const allWordsMatch = searchWords.every(word => normalizedText.includes(word));
          if (allWordsMatch) return true;
          
          // Character sequence match (fuzzy)
          let textIndex = 0;
          for (let i = 0; i < normalizedSearch.length; i++) {
            const char = normalizedSearch[i];
            const foundIndex = normalizedText.indexOf(char, textIndex);
            if (foundIndex === -1) return false;
            textIndex = foundIndex + 1;
          }
          return true;
        }

        function applyFilters() {
          let visibleCount = 0;

          programItems.forEach((item) => {
            const audience = item.getAttribute('data-audience') || '';
            const goal = item.getAttribute('data-goal') || '';

            const matchesAudience = !currentFilters.audience || audience === currentFilters.audience;
            const matchesGoal = !currentFilters.goalSearch || fuzzyMatch(goal, currentFilters.goalSearch);

            if (matchesAudience && matchesGoal) {
              item.style.display = '';
              visibleCount++;
            } else {
              item.style.display = 'none';
            }
          });

          // Show/hide no results message
          if (visibleCount === 0) {
            if (programsGrid) programsGrid.style.display = 'none';
            if (noResults) noResults.classList.remove('hidden');
          } else {
            if (programsGrid) programsGrid.style.display = 'grid';
            if (noResults) noResults.classList.add('hidden');
          }
        }

        function updateActiveStates() {
          // Update audience chip active states
          filterChips.forEach((chip) => {
            const filterType = chip.getAttribute('data-filter');
            const filterValue = chip.getAttribute('data-value') || '';
            
            if (filterType === 'audience' && filterValue === currentFilters.audience) {
              chip.classList.add('bg-[#2841CF]', 'text-white');
              chip.classList.remove('bg-[#F6F7FB]', 'text-black');
            } else if (filterType === 'audience') {
              chip.classList.remove('bg-[#2841CF]', 'text-white');
              chip.classList.add('bg-[#F6F7FB]', 'text-black');
            }
          });
        }

        // Audience chip clicks
        filterChips.forEach((chip) => {
          chip.addEventListener('click', function() {
            const filterType = this.getAttribute('data-filter');
            const filterValue = this.getAttribute('data-value') || '';
            
            if (filterType === 'audience') {
              currentFilters.audience = currentFilters.audience === filterValue ? '' : filterValue;
              applyFilters();
              updateActiveStates();
            }
          });
        });

        // Goal search input
        if (goalSearch) {
          let searchTimeout;
          goalSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              currentFilters.goalSearch = this.value.trim();
              applyFilters();
            }, 300); // Debounce 300ms
          });
        }

        // Initialize
        applyFilters();
        updateActiveStates();
      }

      // Wait for DOM to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFilters);
      } else {
        initFilters();
      }

      // Form submission handlers for category page
      const form = document.getElementById('resource-form');
      const messageDiv = document.getElementById('resource-form-message');
      const successDiv = document.getElementById('resource-form-success');
      
      if (form && messageDiv && successDiv) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(form);
          const data = {
            name: formData.get('name'),
            email: formData.get('email'),
            source: 'program-category-page',
            category: category ? (category.name_en || '') : '',
            page_url: window.location.href,
          };

          try {
            const response = await fetch('/api/form', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              form.style.display = 'none';
              successDiv.classList.remove('hidden');
            } else {
              const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
              console.error('Form submission failed:', response.status, errorData);
              throw new Error(errorData.error || 'Form submission failed');
            }
          } catch (error) {
            console.error('Form submission error:', error);
            messageDiv.textContent = error instanceof Error ? error.message : 'Something went wrong. Please try again.';
            messageDiv.className = 'text-center mt-4 text-red-600';
            messageDiv.classList.remove('hidden');
          }
        });
      }

      const formBottom = document.getElementById('resource-form-bottom');
      const messageDivBottom = document.getElementById('resource-form-bottom-message');
      const successDivBottom = document.getElementById('resource-form-bottom-success');
      
      if (formBottom && messageDivBottom && successDivBottom) {
        formBottom.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(formBottom);
          const data = {
            name: formData.get('name'),
            email: formData.get('email'),
            source: 'program-category-page-bottom',
            category: category ? (category.name_en || '') : '',
            page_url: window.location.href,
          };

          try {
            const response = await fetch('/api/form', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              formBottom.style.display = 'none';
              successDivBottom.classList.remove('hidden');
            } else {
              const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
              console.error('Form submission failed:', response.status, errorData);
              throw new Error(errorData.error || 'Form submission failed');
            }
          } catch (error) {
            console.error('Form submission error:', error);
            messageDivBottom.textContent = error instanceof Error ? error.message : 'Something went wrong. Please try again.';
            messageDivBottom.className = 'text-center mt-4 text-red-600';
            messageDivBottom.classList.remove('hidden');
          }
        });
      }
    })();
  </script>
)}

{programForSlug && (
  <script is:inline>
    (function() {
      function initFAQ() {
        var faqToggles = document.querySelectorAll('.faq-toggle');
        
        for (var i = 0; i < faqToggles.length; i++) {
          var toggle = faqToggles[i];
          toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var index = this.getAttribute('data-faq-index');
            var content = document.querySelector('[data-faq-content="' + index + '"]');
            var icon = this.querySelector('.faq-icon');
            var faqItem = document.querySelector('[data-faq-item="' + index + '"]');
            var isExpanded = this.getAttribute('aria-expanded') === 'true';
            
            if (content && icon && faqItem) {
              if (isExpanded) {
                content.style.maxHeight = '0';
                icon.style.transform = 'rotate(0deg)';
                this.setAttribute('aria-expanded', 'false');
                faqItem.style.backgroundColor = '';
              } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(180deg)';
                this.setAttribute('aria-expanded', 'true');
                faqItem.style.backgroundColor = '#f9fafb';
              }
            }
          });
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFAQ);
      } else {
        initFAQ();
      }
    })();
  </script>
  <script is:inline>
    (function() {
      // Handle first form (after keypoints)
      const form = document.getElementById('resource-form');
      const messageDiv = document.getElementById('resource-form-message');
      const successDiv = document.getElementById('resource-form-success');
      
      if (form && messageDiv && successDiv) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(form);
          const data = {
            type: 'program form',
            name: formData.get('name'),
            email: formData.get('email'),
            program_slug: window.location.pathname.split('/').pop() || '',
            program_title: document.querySelector('h1')?.textContent || '',
            page_url: window.location.href,
          };
          
          try {
            const response = await fetch('/api/form', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });
            
            if (response.ok) {
              form.style.display = 'none';
              successDiv.classList.remove('hidden');
            } else {
              const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
              console.error('Form submission failed:', response.status, errorData);
              throw new Error(errorData.error || 'Form submission failed');
            }
          } catch (error) {
            console.error('Form error:', error);
            messageDiv.className = 'block text-red-600 font-semibold';
            messageDiv.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.';
          }
        });
      }

      // Handle bottom form
      const formBottom = document.getElementById('resource-form-bottom');
      const messageDivBottom = document.getElementById('resource-form-bottom-message');
      const successDivBottom = document.getElementById('resource-form-bottom-success');
      
      if (formBottom && messageDivBottom && successDivBottom) {
        formBottom.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(formBottom);
          const data = {
            type: 'program form bottom',
            name: formData.get('name'),
            email: formData.get('email'),
            program_slug: window.location.pathname.split('/').pop() || '',
            program_title: document.querySelector('h1')?.textContent || '',
            page_url: window.location.href,
          };
          
          try {
            const response = await fetch('/api/form', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });
            
            if (response.ok) {
              formBottom.style.display = 'none';
              successDivBottom.classList.remove('hidden');
            } else {
              const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
              console.error('Form submission failed:', response.status, errorData);
              throw new Error(errorData.error || 'Form submission failed');
            }
          } catch (error) {
            console.error('Form error:', error);
            messageDivBottom.className = 'block text-red-600 font-semibold';
            messageDivBottom.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.';
          }
        });
      }
    })();
  </script>
)}
