---
import ContentLayout from '@layouts/ContentLayout.astro';
import { supabase, type Program, type Category, CATEGORY_FULL_FIELDS } from '@lib/supabase';
import { getTranslations, getLocalizedPath, type Language, getLanguageFromCookie } from '@lib/i18n';
import { marked } from 'marked';
import { slugify } from '@lib/utils';

export const prerender = false; // Edge SSR

// Set cache headers for Edge SSR
// Set cache headers for Edge SSR (detail pages: 10 min)
Astro.response.headers.set(
  'Cache-Control',
  'public, max-age=600, stale-while-revalidate=1200'
);

const lang = getLanguageFromCookie(Astro.cookies, Astro.url) || 'en';
const slug = (Astro.params.slug || '').trim();
const t = getTranslations(lang);

let program: Program | null = null;
let category: Category | null = null;
let relatedPrograms: Program[] = [];
let categoryMap: Map<string, Category> = new Map();

try {
  // Get all categories first for mapping (selective fields)
  const { data: categoriesData } = await supabase
    .from('categories')
    .select(CATEGORY_FULL_FIELDS)
    .eq('type', 'program')
    .order('sort_order', { ascending: true });

  if (categoriesData) {
    categoriesData.forEach((cat) => {
      categoryMap.set(cat.id, cat);
      categoryMap.set(cat.slug, cat);
      categoryMap.set(cat.name_en, cat);
      if (cat.name_fi) categoryMap.set(cat.name_fi, cat);
      if (cat.name_sv) categoryMap.set(cat.name_sv, cat);
    });
  }

  // CRITICAL: This route is ONLY for program slugs, never for category slugs
  // Category slugs should always go to /programs?category=... format
  // Get program by slug - try current language first, then all languages as fallback
  const { data: programDataLang, error: errorLang } = await supabase
    .from('programs')
    .select('*')
    .eq('slug', slug)
    .eq('language', lang)
    .eq('is_published', true)
    .maybeSingle();
  
  if (errorLang) {
    console.error('[Program Slug Route] Error fetching program with language:', errorLang);
  }
  
  // If not found in current language, try all languages
  if (!programDataLang) {
    const { data: programDataAll, error: errorAll } = await supabase
      .from('programs')
      .select('*')
      .eq('slug', slug)
      .eq('is_published', true)
      .maybeSingle();
    
    if (errorAll) {
      console.error('[Program Slug Route] Error fetching program (all languages):', errorAll);
    }
    
    program = programDataAll || null;
  } else {
    program = programDataLang;
  }
  
  // Log for debugging
  if (import.meta.env.DEV) {
    console.log('[Program Slug Route] Checking slug:', slug, 'language:', lang);
    if (program) {
      console.log('[Program Slug Route] ✓ Found program:', program.title, 'slug:', program.slug, 'language:', program.language);
    } else {
      console.log('[Program Slug Route] ✗ Program not found for slug:', slug);
      console.log('[Program Slug Route] This means the slug does not exist in programs table or is not published');
      console.log('[Program Slug Route] Returning 404 - this route is ONLY for programs, not categories');
    }
  }
  
  // REMOVED: Category check - this route is ONLY for programs
  // If someone tries to access a category slug here, they should get 404
  // Category slugs must use /programs?category=... format

  // Get category info if program found (optimized lookup)
  if (program?.category) {
    // First try categoryMap
    let categoryData = categoryMap.get(program.category);
    
    // If not found in map, try single optimized query with .or()
    if (!categoryData) {
      const { data: catData } = await supabase
        .from('categories')
        .select('id, slug, name_en, name_fi, name_sv, description_en, description_fi, description_sv, type, sort_order')
        .or(`id.eq.${program.category},slug.eq.${program.category},name_en.eq.${program.category},name_fi.eq.${program.category},name_sv.eq.${program.category}`)
        .eq('type', 'program')
        .maybeSingle();
      
      categoryData = catData || null;
    }
    
    category = categoryData;
  }

  // Get related programs (same category, excluding current program) - optimized with selective fields
  // Programs.category stores category NAME, so match by category name
  if (program && category) {
    try {
      const categoryName = category[`name_${lang}` as keyof Category] || category.name_en;
      const { data: relatedData } = await supabase
        .from('programs')
        .select('id, slug, title, excerpt, cover_image_url, category, published_at, goal, duration, audience')
        .eq('language', lang)
        .eq('is_published', true)
        .eq('category', categoryName)
        .neq('id', program.id)
        .order('published_at', { ascending: false })
        .limit(10);

      relatedPrograms = (relatedData || []) as Program[];
    } catch (error) {
      console.error('Error fetching related programs:', error);
    }
  }
} catch (error) {
  console.error('Error fetching program:', error);
}

if (!program) {
  // Program not found and not a category either - return 404
  if (import.meta.env.DEV) {
    console.log('[Program Slug Route] ✗ Slug is neither program nor category, returning 404:', slug);
  }
  return new Response(null, { status: 404 });
}

const canonical = `https://plademy.com/programs/${slug}`;

let relatedProgramsLabel: string | undefined = undefined;
if (category) {
  const categoryName = String(category[`name_${lang}` as keyof Category] || category.name_en);
  const baseLabel = t.programs.relatedProgramsInterest || 'You might be interested in programs';
  relatedProgramsLabel = baseLabel.replace('{category}', categoryName);
}

// Process program content - moved from IIFE to frontmatter
let processedContent: string | null = null;
// Privacy notice HTML - moved from JSX attribute to frontmatter
let privacyNoticeHTML: string = '';
if (t.forms.program.privacyNotice) {
  privacyNoticeHTML = t.forms.program.privacyNotice.replace('{privacyPolicy}', `<a href="${getLocalizedPath('/privacy', lang)}" class="font-bold">${t.forms.program.privacyPolicy}</a>`);
}

if (program && program.content) {
  // Clean up malformed checkmark patterns - catch ALL variations of $render with checkmark
  const cleanedContent = program.content
    .replace(/\$render[^✓]*✓[^<]*/g, '✓')
    .replace(/\$render[^✓]*✓[^<]*/g, '✓') // Run twice to catch nested patterns
    .replace(/`✓`/g, '✓')
    .replace(/\$render/g, '') // Remove any remaining $render without checkmark
    .replace(/\\`✓\\`/g, '✓')
    .replace(/\\`/g, '');
  
  const parsedContent = marked.parse(cleanedContent) as string;
  processedContent = parsedContent
    // Replace any $render pattern with checkmark - multiple passes for reliability
    .replace(/\$render[^✓]*✓[^<]*/g, '✓')
    .replace(/\$render[^✓]*✓[^<]*/g, '✓') // Second pass
    // Handle HTML entities and encoded characters
    .replace(/\$render[^✓]*✓[^<]*/g, '✓')
    // Replace in any HTML tag content
    .replace(/>([^<]*)\$render[^✓]*✓[^<]*(<)/g, (match, before, after) => {
      return `>${before.replace(/\$render[^✓]*✓[^<]*/g, '✓')}${after}`;
    })
    // Handle list items specifically - more aggressive
    .replace(/<li([^>]*)>([^<]*)\$render[^✓]*✓[^<]*/gi, '<li$1>✓$2')
    .replace(/<li([^>]*)>([^<]*)\$render[^✓]*✓[^<]*/gi, '<li$1>✓$2') // Second pass
    // Remove any remaining $render
    .replace(/\$render/g, '')
    .replace(/<h3([^>]*)>(.*?)<\/h3>/gi, (_match: string, attrs: string, text: string) => {
      const id = slugify(text.replace(/<[^>]*>/g, ''));
      return `<h3${attrs} id="${id}">${text}</h3>`;
    })
    .replace(/<input[^>]*type=["']checkbox["'][^>]*>/gi, '<span class="text-primary mr-2">✓</span>');
}

// Generate mobile cards HTML
let mobileCardsHTML = '';
if (program && (program.goal || program.duration || program.audience)) {
  console.log('[DEBUG] Creating mobileCardsHTML with:', { goal: program.goal, duration: program.duration, audience: program.audience });
  mobileCardsHTML = '<div class="mobile-program-cards flex flex-col mb-8 space-y-4 w-full max-w-full not-prose">';
  if (program.goal) {
    mobileCardsHTML += `
      <div class="bg-green-50 rounded-3xl p-6 w-full">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h2 class="text-xl font-bold mb-2">Program Goal</h2>
            <p class="text-base">${program.goal}</p>
          </div>
        </div>
      </div>
    `;
  }
  if (program.duration) {
    mobileCardsHTML += `
      <div class="bg-purple-50 rounded-3xl p-6 w-full">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 text-purple-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h2 class="text-xl font-bold mb-2">Program Duration</h2>
            <p class="text-base">${program.duration}</p>
          </div>
        </div>
      </div>
    `;
  }
  if (program.audience) {
    mobileCardsHTML += `
      <div class="bg-yellow-50 rounded-3xl p-6 w-full">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <div>
            <h2 class="text-xl font-bold mb-2">Target Audience</h2>
            <p class="text-base">${program.audience}</p>
          </div>
        </div>
      </div>
    `;
  }
  mobileCardsHTML += '</div>';
}

---

<ContentLayout
  title={program.title}
  description={program.description || program.excerpt || undefined}
  image={program.cover_image_url || undefined}
  lang={lang}
  publishedTime={program.published_at}
  canonical={canonical}
    relatedPrograms={relatedPrograms}
    relatedProgramsLabel={relatedProgramsLabel}
    programGoal={program.goal || undefined}
    programDuration={program.duration || undefined}
    programAudience={program.audience || undefined}
>
  <div slot="after-description">
    {category && (
      <div class="mb-6">
        <a
          href={`/programs?category=${category.slug}`}
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-white border border-gray-200 text-black hover:opacity-80 transition-opacity"
        >
          {String(category[`name_${lang}` as keyof Category] || category.name_en)}
        </a>
      </div>
    )}
  </div>

  {program.cover_image_url && (
    <img
      src={program.cover_image_url}
      alt={program.title}
      class="w-full h-96 object-cover rounded-3xl mb-8"
      loading="eager"
      width="1200"
      height="600"
      decoding="async"
      fetchpriority="high"
    />
  )}

  {mobileCardsHTML && (
    <div set:html={mobileCardsHTML}></div>
  )}

  {program.keypoints && program.keypoints.length > 0 && (
    <div class="bg-blue-50 rounded-3xl p-12 mb-8 w-full max-w-full">
      <h2 class="text-2xl font-bold mb-4">Key Points</h2>
      <ul class="space-y-4 keypoints-list">
        {program.keypoints.map((point) => (
          <li class="flex items-start">
            <span class="text-primary mr-2">✓</span>
            <span>{point}</span>
          </li>
        ))}
      </ul>
    </div>
  )}

    <!-- Resource Form (After Keypoints) -->
    <div class="card mb-8 p-8 md:p-12 w-full max-w-full" id="resource-form-container" style="min-height: 200px;">
      <form
        id="resource-form"
        name="resource form"
        class="grid md:grid-cols-2 gap-8 items-center"
      >
        <div>
          <h3 class="text-2xl font-bold mb-3">
            {t.programs.formTitle || 'Start implementing this program today'}
          </h3>
          <p class="text-black">
            {program?.title 
              ? (t.programs.formDescription || 'AI Powered Solutions For Your {programTitle}').replace('{programTitle}', program.title)
              : 'AI Powered Mentoring, Coaching, Community Management and Training Platforms'}
          </p>
        </div>
      <div class="space-y-4">
        <div>
          <input
            type="text"
            id="resource-form-name"
            name="name"
            placeholder="Full Name"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
          />
        </div>
        <div>
          <input
            type="email"
            id="resource-form-email"
            name="email"
            placeholder="Email"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
          />
        </div>
        <button
          type="submit"
          class="btn btn-primary w-full"
        >
          Get Started For Free
        </button>
        <p class="!text-[10px] text-gray-600 md:col-span-2 not-prose" set:html={privacyNoticeHTML}></p>
      </div>
    </form>
    <div id="resource-form-success" class="hidden text-center py-8">
      <h3 class="text-2xl font-bold mb-2">{t.forms.program.successTitle}</h3>
      <p class="text-gray-600">{t.forms.program.successMessage}</p>
    </div>
    <div id="resource-form-message" class="hidden text-center mt-4"></div>
  </div>

  {processedContent && (
    <div 
      class="prose prose-lg max-w-none content-prose"
      set:html={processedContent}
    />
  )}

  {program.faqs && program.faqs.length > 0 && (
    <div id="frequently-asked-questions" class="mt-12">
      <h2 class="text-3xl font-bold mb-6">Frequently Asked Questions</h2>
      <div class="space-y-4">
        {program.faqs.map((faq: any, index: number) => (
          <div class="rounded-3xl overflow-hidden faq-item hover:border-black transition-colors border border-gray-200 bg-white" data-faq-item={index}>
            <button
              class="w-full text-left flex items-center justify-between py-[15px] px-6 faq-toggle"
              data-faq-index={index}
              aria-expanded="false"
            >
              <h3 class="text-xl font-bold pr-4">{faq.question}</h3>
              <svg
                class="w-5 h-5 text-gray-500 flex-shrink-0 faq-icon transition-transform"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="faq-content max-h-0 overflow-hidden transition-all duration-300 ease-in-out" data-faq-content={index}>
              <div class="px-6 pb-6 text-black">
                <p>{faq.answer}</p>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  )}

    <!-- Resource Form (Bottom) -->
    <div class="card mb-8 p-8 md:p-12 mt-12 w-full max-w-full" id="resource-form-bottom-container" style="min-height: 200px;">
      <form
        id="resource-form-bottom"
        name="resource form"
        class="grid md:grid-cols-2 gap-8 items-center"
      >
        <div>
          <h3 class="text-2xl font-bold mb-3">
            {t.programs.formTitle || 'Start implementing this program today'}
          </h3>
          <p class="text-black">
            {program?.title 
              ? (t.programs.formDescription || 'AI Powered Solutions For Your {programTitle}').replace('{programTitle}', program.title)
              : 'AI Powered Mentoring, Coaching, Community Management and Training Platforms'}
          </p>
        </div>
      <div class="space-y-4">
        <div>
          <input
            type="text"
            id="resource-form-bottom-name"
            name="name"
            placeholder="Full Name"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
          />
        </div>
        <div>
          <input
            type="email"
            id="resource-form-bottom-email"
            name="email"
            placeholder="Email"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
          />
        </div>
        <button
          type="submit"
          class="btn btn-primary w-full"
        >
          Get Started For Free
        </button>
        <p class="!text-[10px] text-gray-600 md:col-span-2 not-prose" set:html={privacyNoticeHTML}></p>
      </div>
    </form>
    <div id="resource-form-bottom-success" class="hidden text-center py-8">
      <h3 class="text-2xl font-bold mb-2">{t.forms.program.successTitle}</h3>
      <p class="text-gray-600">{t.forms.program.successMessage}</p>
    </div>
    <div id="resource-form-bottom-message" class="hidden text-center mt-4"></div>
  </div>

  <div class="mt-8 pt-8 border-t">
    <a href="/programs/" class="text-primary hover:underline">
      ← {t.common.back} to Programs
    </a>
  </div>
</ContentLayout>

<script is:inline>
  (function() {
    function initFAQ() {
      var faqToggles = document.querySelectorAll('.faq-toggle');
      
      for (var i = 0; i < faqToggles.length; i++) {
        var toggle = faqToggles[i];
        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          var index = this.getAttribute('data-faq-index');
          var content = document.querySelector('[data-faq-content="' + index + '"]');
          var icon = this.querySelector('.faq-icon');
          var faqItem = document.querySelector('[data-faq-item="' + index + '"]');
          var isExpanded = this.getAttribute('aria-expanded') === 'true';
          
          // Toggle current FAQ (don't close others)
          if (content && icon && faqItem) {
            if (isExpanded) {
              content.style.maxHeight = '0';
              icon.style.transform = 'rotate(0deg)';
              this.setAttribute('aria-expanded', 'false');
              faqItem.style.backgroundColor = '';
            } else {
              content.style.maxHeight = content.scrollHeight + 'px';
              icon.style.transform = 'rotate(180deg)';
              this.setAttribute('aria-expanded', 'true');
              faqItem.style.backgroundColor = '#f9fafb';
            }
          }
        });
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFAQ);
    } else {
      initFAQ();
    }
  })();
</script>
<script is:inline>
  (function() {
    // Handle first form (after keypoints)
    const form = document.getElementById('resource-form');
    const messageDiv = document.getElementById('resource-form-message');
    const successDiv = document.getElementById('resource-form-success');
    
    if (form && messageDiv && successDiv) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {
          type: 'program form',
          name: formData.get('name'),
          email: formData.get('email'),
          program_slug: window.location.pathname.split('/').pop() || '',
          program_title: document.querySelector('h1')?.textContent || '',
          page_url: window.location.href,
        };
        
        try {
          const response = await fetch('/api/form', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          
          if (response.ok) {
            form.style.display = 'none';
            successDiv.classList.remove('hidden');
          } else {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            console.error('Form submission failed:', response.status, errorData);
            throw new Error(errorData.error || 'Form submission failed');
          }
        } catch (error) {
          console.error('Form error:', error);
          messageDiv.className = 'block text-red-600 font-semibold';
          messageDiv.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.';
        }
      });
    }

    // Handle bottom form
    const formBottom = document.getElementById('resource-form-bottom');
    const messageDivBottom = document.getElementById('resource-form-bottom-message');
    const successDivBottom = document.getElementById('resource-form-bottom-success');
    
    if (formBottom && messageDivBottom && successDivBottom) {
      formBottom.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(formBottom);
        const data = {
          type: 'program form bottom',
          name: formData.get('name'),
          email: formData.get('email'),
          program_slug: window.location.pathname.split('/').pop() || '',
          program_title: document.querySelector('h1')?.textContent || '',
          page_url: window.location.href,
        };
        
        try {
          const response = await fetch('/api/form', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          
          if (response.ok) {
            formBottom.style.display = 'none';
            successDivBottom.classList.remove('hidden');
          } else {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            console.error('Form submission failed:', response.status, errorData);
            throw new Error(errorData.error || 'Form submission failed');
          }
        } catch (error) {
          console.error('Form error:', error);
          messageDivBottom.className = 'block text-red-600 font-semibold';
          messageDivBottom.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.';
        }
      });
    }
  })();

  // Force mobile cards visibility - AGGRESSIVE
  (function() {
    function showMobileCards() {
      const cards = document.querySelectorAll('.mobile-program-cards');
      const isMobile = window.innerWidth <= 1023;
      
      console.log('[Mobile Cards] Found cards:', cards.length, 'isMobile:', isMobile);
      
      cards.forEach((card, index) => {
        if (!card) {
          console.log('[Mobile Cards] Card', index, 'is null');
          return;
        }
        
        console.log('[Mobile Cards] Card', index, 'found, parent:', card.parentElement?.tagName);
        
        if (isMobile) {
          // Force all styles
          card.style.setProperty('display', 'flex', 'important');
          card.style.setProperty('visibility', 'visible', 'important');
          card.style.setProperty('opacity', '1', 'important');
          card.style.setProperty('flex-direction', 'column', 'important');
          card.style.setProperty('width', '100%', 'important');
          card.style.setProperty('max-width', '100%', 'important');
          card.style.setProperty('position', 'relative', 'important');
          card.style.setProperty('z-index', '1', 'important');
          console.log('[Mobile Cards] Card', index, 'made visible');
        } else {
          card.style.setProperty('display', 'none', 'important');
        }
      });
    }
    
    // Run immediately
    setTimeout(showMobileCards, 0);
    
    // Run on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(showMobileCards, 100);
      });
    } else {
      setTimeout(showMobileCards, 100);
    }
    
    // Run on resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(showMobileCards, 100);
    });
  })();
</script>
