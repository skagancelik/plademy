---
import PageLayout from '@layouts/PageLayout.astro';
import ProgramCard from '@components/programs/ProgramCard.astro';
import { supabase, type Program, type Category } from '@lib/supabase';
import { getTranslations, type Language, getLanguageFromCookie } from '@lib/i18n';

export const prerender = false; // Edge SSR

const lang = getLanguageFromCookie(Astro.cookies, Astro.url) || 'en';
const t = getTranslations(lang);

let programs: Program[] = [];
let categories: Category[] = [];
let uniqueAudiences: string[] = [];
let categoryMap: Map<string, Category> = new Map();

try {
  // Fetch all programs (no limit for filtering)
  const { data: programsData } = await supabase
    .from('programs')
    .select('*')
    .eq('language', lang)
    .eq('is_published', true)
    .order('published_at', { ascending: false });

  const { data: categoriesData } = await supabase
    .from('categories')
    .select('*')
    .eq('type', 'program')
    .order('sort_order', { ascending: true });

  programs = programsData || [];
  categories = categoriesData || [];

  // Create category map for quick lookup
  categories.forEach((cat) => {
    categoryMap.set(cat.id, cat);
    categoryMap.set(cat.slug, cat);
    categoryMap.set(cat.name_en, cat);
  });

  // Extract unique audiences
  const audiences = new Set<string>();
  
  programs.forEach((program) => {
    if (program.audience && program.audience.trim()) {
      audiences.add(program.audience.trim());
    }
  });

  uniqueAudiences = Array.from(audiences).sort();
  
  // Debug: Log program slugs
  if (import.meta.env.DEV && programs.length > 0) {
    console.log('[Programs Index] Available program slugs:', programs.map(p => ({ slug: p.slug, title: p.title, lang: p.language })));
  }
} catch (error) {
  console.error('Error fetching programs:', error);
}
---

<PageLayout
  title={t.programs.title}
  description={t.programs.description}
  lang={lang}
>
  <div class="container py-12">
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-4">{t.programs.title}</h1>
      <p class="text-xl text-black">{t.programs.description}</p>
    </div>

    <!-- Filters Section -->
    <div class="mb-8 space-y-6">
      <!-- Category Filter (Buttons) -->
      <div>
        <div class="flex flex-wrap gap-2">
          <button
            data-filter="category"
            data-value=""
            class="filter-chip category-chip px-4 py-2 bg-[#2841CF] text-white rounded-full hover:opacity-90 transition-colors"
          >
            {t.programs.allPrograms || 'All Programs'}
          </button>
          {categories.map((category) => {
            const categoryName = category[`name_${lang}` as keyof Category] || category.name_en;
            return (
              <button
                data-filter="category"
                data-value={category.id}
                class="filter-chip category-chip px-4 py-2 bg-[#F6F7FB] text-black rounded-full hover:opacity-80 transition-colors"
              >
                {categoryName}
              </button>
            );
          })}
        </div>
      </div>

      <!-- Audience Filter (Chips) -->
      {uniqueAudiences.length > 0 && (
        <div>
          <div class="flex flex-wrap gap-2">
            <button
              data-filter="audience"
              data-value=""
              class="filter-chip px-4 py-2 bg-[#F6F7FB] text-black rounded-full hover:opacity-80 transition-colors"
            >
              {t.programs.allAudiences || 'All Audiences'}
            </button>
            {uniqueAudiences.map((audience) => (
              <button
                data-filter="audience"
                data-value={audience}
                class="filter-chip px-4 py-2 bg-[#F6F7FB] text-black rounded-full hover:opacity-80 transition-colors"
              >
                {audience}
              </button>
            ))}
          </div>
        </div>
      )}

      <!-- Goal Search Filter -->
      <div>
        <input
          type="text"
          id="goal-search"
          placeholder={t.programs.searchGoalPlaceholder || 'Type to search program goals...'}
          class="w-full px-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent bg-white"
        />
      </div>
    </div>

    <!-- Programs Grid -->
    <div id="programs-container">
      {programs.length > 0 ? (
        <div class="grid md:grid-cols-3 gap-6" id="programs-grid">
          {programs.map((program) => {
            // Find category by trying multiple lookup methods
            let programCategory: Category | null = null;
            let categoryId = '';
            
            if (program.category) {
              // Try direct lookup first
              programCategory = categoryMap.get(program.category) || null;
              
              // If not found, try to find by iterating through categories
              if (!programCategory) {
                for (const cat of categories) {
                  if (cat.id === program.category || 
                      cat.slug === program.category || 
                      cat.name_en === program.category ||
                      cat.name_fi === program.category ||
                      cat.name_sv === program.category) {
                    programCategory = cat;
                    break;
                  }
                }
              }
              
              // Set category ID for filtering
              if (programCategory) {
                categoryId = programCategory.id;
              }
            }
            
            return (
              <div
                class="program-item h-full"
                data-category-id={categoryId}
                data-category={program.category || ''}
                data-audience={program.audience || ''}
                data-goal={program.goal || ''}
              >
                <ProgramCard program={program} lang={lang} category={programCategory} />
              </div>
            );
          })}
        </div>
      ) : (
        <p class="text-center text-gray-500 py-12">{t.programs.noPrograms}</p>
      )}
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center text-gray-500 py-12">
      {t.programs.noPrograms}
    </div>
  </div>
</PageLayout>

<script is:inline>
  (function() {
    function initFilters() {
      const categoryChips = document.querySelectorAll('.category-chip');
      const filterChips = document.querySelectorAll('.filter-chip:not(.category-chip)');
      const goalSearch = document.getElementById('goal-search');
      const programsGrid = document.getElementById('programs-grid');
      const noResults = document.getElementById('no-results');
      const programItems = document.querySelectorAll('.program-item');

      if (!programItems || programItems.length === 0) {
        console.warn('No program items found');
        return;
      }

      let currentFilters = {
        category: '',
        audience: '',
        goalSearch: ''
      };

    // Fuzzy search function for goal matching
    function fuzzyMatch(text, searchTerm) {
      if (!searchTerm || !text) return true;
      
      const normalizedText = text.toLowerCase().trim();
      const normalizedSearch = searchTerm.toLowerCase().trim();
      
      // Exact match
      if (normalizedText.includes(normalizedSearch)) return true;
      
      // Word-by-word match (all words must be present)
      const searchWords = normalizedSearch.split(/\s+/).filter(w => w.length > 0);
      if (searchWords.length === 0) return true;
      
      const allWordsMatch = searchWords.every(word => normalizedText.includes(word));
      if (allWordsMatch) return true;
      
      // Character sequence match (fuzzy)
      let textIndex = 0;
      for (let i = 0; i < normalizedSearch.length; i++) {
        const char = normalizedSearch[i];
        const foundIndex = normalizedText.indexOf(char, textIndex);
        if (foundIndex === -1) return false;
        textIndex = foundIndex + 1;
      }
      return true;
    }

    function applyFilters() {
      let visibleCount = 0;

      programItems.forEach((item) => {
        const categoryId = item.getAttribute('data-category-id') || '';
        const category = item.getAttribute('data-category') || '';
        const audience = item.getAttribute('data-audience') || '';
        const goal = item.getAttribute('data-goal') || '';

        // Match category by ID (preferred) or by original category value
        // If categoryId is set, use it; otherwise fall back to category value
        let matchesCategory = true;
        if (currentFilters.category) {
          if (categoryId) {
            matchesCategory = categoryId === currentFilters.category;
          } else {
            matchesCategory = category === currentFilters.category;
          }
        }
        
        const matchesAudience = !currentFilters.audience || audience === currentFilters.audience;
        const matchesGoal = !currentFilters.goalSearch || fuzzyMatch(goal, currentFilters.goalSearch);

        if (matchesCategory && matchesAudience && matchesGoal) {
          item.style.display = '';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });

      // Show/hide no results message
      if (visibleCount === 0) {
        if (programsGrid) programsGrid.style.display = 'none';
        if (noResults) noResults.classList.remove('hidden');
      } else {
        if (programsGrid) programsGrid.style.display = 'grid';
        if (noResults) noResults.classList.add('hidden');
      }
    }

    function updateActiveStates() {
      // Update category chip active states
      categoryChips.forEach((chip) => {
        const filterValue = chip.getAttribute('data-value') || '';
        
        if (filterValue === currentFilters.category) {
          chip.classList.add('bg-[#2841CF]', 'text-white');
          chip.classList.remove('bg-[#F6F7FB]', 'text-black');
        } else {
          chip.classList.remove('bg-[#2841CF]', 'text-white');
          chip.classList.add('bg-[#F6F7FB]', 'text-black');
        }
      });

      // Update audience chip active states
      filterChips.forEach((chip) => {
        const filterType = chip.getAttribute('data-filter');
        const filterValue = chip.getAttribute('data-value') || '';
        
        if (filterType === 'audience' && filterValue === currentFilters.audience) {
          chip.classList.add('bg-[#2841CF]', 'text-white');
          chip.classList.remove('bg-[#F6F7FB]', 'text-black');
        } else if (filterType === 'audience') {
          chip.classList.remove('bg-[#2841CF]', 'text-white');
          chip.classList.add('bg-[#F6F7FB]', 'text-black');
        }
      });
    }

    // Category chip clicks
    categoryChips.forEach((chip) => {
      chip.addEventListener('click', function() {
        const filterValue = this.getAttribute('data-value') || '';
        currentFilters.category = currentFilters.category === filterValue ? '' : filterValue;
        applyFilters();
        updateActiveStates();
      });
    });

    // Audience chip clicks
    filterChips.forEach((chip) => {
      chip.addEventListener('click', function() {
        const filterType = this.getAttribute('data-filter');
        const filterValue = this.getAttribute('data-value') || '';
        
        if (filterType === 'audience') {
          currentFilters.audience = currentFilters.audience === filterValue ? '' : filterValue;
          applyFilters();
          updateActiveStates();
        }
      });
    });

    // Goal search input
    if (goalSearch) {
      let searchTimeout;
      goalSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentFilters.goalSearch = this.value.trim();
          applyFilters();
        }, 300); // Debounce 300ms
      });
    }

      // Initialize
      applyFilters();
      updateActiveStates();
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFilters);
    } else {
      initFilters();
    }
  })();
</script>
