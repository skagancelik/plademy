---
import { supabase } from '@lib/supabase';
import { getLanguageFromCookie } from '@lib/i18n';

export const prerender = false; // Edge SSR

const lang = getLanguageFromCookie(Astro.cookies, Astro.url) || 'en';

// NEW URL FORMAT: /programs redirects to /programs/all-categories/all-audiences
// This file only handles /programs and /programs/ - redirect to new format
const pathname = Astro.url.pathname;

if (pathname === '/programs' || pathname === '/programs/') {
  // Check for old query parameter format and redirect
  const categoryParam = Astro.url.searchParams.get('category');
  const audienceParam = Astro.url.searchParams.get('audience');
  
  if (categoryParam || audienceParam) {
    // Old format detected - redirect to new format
    // Convert category ID/slug to slug format
    let categorySlug = 'all-categories';
    if (categoryParam && categoryParam !== 'all-categories') {
      // Try to find category and get its slug
      const { data: categoryData } = await supabase
        .from('categories')
        .select('slug')
        .eq('type', 'program')
        .or(`id.eq.${categoryParam},slug.eq.${categoryParam}`)
        .maybeSingle();
      
      if (categoryData?.slug) {
        categorySlug = categoryData.slug;
      } else {
        // If not found, use as-is (might be a slug already)
        categorySlug = categoryParam;
      }
    }
    
    // Convert audience to slug format
    let audienceSlug = 'all-audiences';
    if (audienceParam && audienceParam !== 'all-audiences') {
      // Audience is stored as-is in DB, convert to slug
      audienceSlug = audienceParam.toLowerCase().replace(/\s+/g, '-');
    }
    
    return Astro.redirect(`/programs/${categorySlug}/${audienceSlug}`, 301);
  }
  
  // No filters - redirect to all/all
  return Astro.redirect('/programs/all-categories/all-audiences', 301);
}

// If pathname is /programs/[something], it should be handled by:
// - /programs/[slug].astro (for program detail pages)
// - /programs/[category]/[audience].astro (for filtered listing pages)
// This file should NOT handle these cases - return 404 to let Astro routing try other routes
return new Response(null, { status: 404 });
---
