---
import ContentLayout from '@layouts/ContentLayout.astro';
import { supabase, type Resource, type Category } from '@lib/supabase';
import { getTranslations, getLocalizedPath, type Language, getLanguageFromCookie } from '@lib/i18n';
import { marked } from 'marked';

export const prerender = false; // Edge SSR

const lang = getLanguageFromCookie(Astro.cookies, Astro.url) || 'en';
const slug = (Astro.params.slug || '').trim();
const t = getTranslations(lang);

let resource: Resource | null = null;
let category: Category | null = null;
let relatedResources: Resource[] = [];

try {
  // Use same pattern as homepage - get all and filter by slug
  const { data: resources } = await supabase
    .from('resources')
    .select('*')
    .eq('language', lang)
    .eq('is_published', true)
    .order('published_at', { ascending: false })
    .limit(100);

  // Find by slug in results
  if (resources && resources.length > 0) {
    resource = resources.find(r => (r.slug || '').trim() === slug) || null;
  }

  // If not found, try all languages
  if (!resource) {
    const { data: allResources } = await supabase
      .from('resources')
      .select('*')
      .eq('is_published', true)
      .limit(100);
    
    if (allResources && allResources.length > 0) {
      resource = allResources.find(r => (r.slug || '').trim() === slug) || null;
    }
  }

  // Get category info if resource found
  if (resource?.category) {
    // Try to fetch by ID first (category.id is TEXT, e.g., "community-management")
    let categoryData = null;
    const { data: dataById } = await supabase
      .from('categories')
      .select('*')
      .eq('id', resource.category)
      .eq('type', 'resource')
      .maybeSingle();
    
    if (dataById) {
      categoryData = dataById;
    } else {
      // If ID lookup fails, try by slug
      const { data: dataBySlug } = await supabase
        .from('categories')
        .select('*')
        .eq('slug', resource.category)
        .eq('type', 'resource')
        .maybeSingle();
      
      if (dataBySlug) {
        categoryData = dataBySlug;
      } else {
        // If slug lookup fails, try by name_en (category name might be stored)
        const { data: dataByNameEn } = await supabase
          .from('categories')
          .select('*')
          .eq('name_en', resource.category)
          .eq('type', 'resource')
          .maybeSingle();
        
        if (dataByNameEn) {
          categoryData = dataByNameEn;
        } else {
          // Try name_fi and name_sv as well
          const { data: dataByNameFi } = await supabase
            .from('categories')
            .select('*')
            .eq('name_fi', resource.category)
            .eq('type', 'resource')
            .maybeSingle();
          
          if (dataByNameFi) {
            categoryData = dataByNameFi;
          } else {
            const { data: dataByNameSv } = await supabase
              .from('categories')
              .select('*')
              .eq('name_sv', resource.category)
              .eq('type', 'resource')
              .maybeSingle();
            
            if (dataByNameSv) {
              categoryData = dataByNameSv;
            }
          }
        }
      }
    }
    
    category = categoryData || null;
  }

  // Get related resources (same category, excluding current resource)
  if (resource && category) {
    try {
      const { data: relatedData } = await supabase
        .from('resources')
        .select('*')
        .eq('language', lang)
        .eq('is_published', true)
        .eq('category', category.id)
        .neq('id', resource.id)
        .order('published_at', { ascending: false })
        .limit(10);

      relatedResources = relatedData || [];
    } catch (error) {
      console.error('Error fetching related resources:', error);
    }
  }
} catch (error) {
  console.error('Error fetching resource:', error);
}

if (!resource) {
  return new Response(null, { status: 404 });
}

const canonical = `https://plademy.com/resources/${slug}`;
---

<ContentLayout
  title={resource.title}
  description={resource.description || resource.excerpt || undefined}
  image={resource.cover_image_url || undefined}
  lang={lang}
  publishedTime={resource.published_at}
  canonical={canonical}
  relatedResources={relatedResources}
  relatedResourcesLabel={category ? ((t.resources.relatedArticles || 'Related Articles').replace('{category}', String(category[`name_${lang}` as keyof Category] || category.name_en))) : undefined}
>
  <div slot="after-description">
    {category && (
      <div class="mb-6">
        <a
          href={`/resources/${category.slug}`}
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-white border border-gray-200 text-black hover:opacity-80 transition-opacity"
        >
          {String(category[`name_${lang}` as keyof Category] || category.name_en)}
        </a>
      </div>
    )}
  </div>

  {resource.cover_image_url && (
    <img
      src={resource.cover_image_url}
      alt={resource.title}
      class="w-full h-96 object-cover rounded-lg mb-8"
      loading="eager"
      width="1200"
      height="600"
      decoding="async"
      fetchpriority="high"
    />
  )}

  {resource.keypoints && resource.keypoints.length > 0 && (
    <div class="bg-blue-50 border-l-4 border-primary p-6 mb-8">
      <h2 class="text-2xl font-bold mb-4">Key Points</h2>
      <ul class="space-y-2">
        {resource.keypoints.map((point) => (
          <li class="flex items-start">
            <span class="text-primary mr-2">✓</span>
            <span>{point}</span>
          </li>
        ))}
      </ul>
    </div>
  )}

  <!-- Resource Form (After Keypoints) -->
  <div class="card mb-8 p-8 md:p-12" id="resource-form-container" style="min-height: 200px;">
    <form
      id="resource-form"
      name="resource form"
      class="grid md:grid-cols-2 gap-8 items-center"
    >
      <div>
        <h3 class="text-2xl font-bold mb-3">Boost your organization with Plademy solutions</h3>
        <p class="text-black">AI Powered Mentoring, Coaching, Community Management and Training Platforms</p>
      </div>
      <div class="space-y-4">
        <div>
          <input
            type="text"
            id="resource-form-name"
            name="name"
            placeholder="Full Name"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
          />
        </div>
        <div>
          <input
            type="email"
            id="resource-form-email"
            name="email"
            placeholder="Email"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
          />
        </div>
        <button
          type="submit"
          class="btn btn-primary w-full"
        >
          Get Started For Free
        </button>
        <p class="text-[10px] text-gray-600 md:col-span-2" set:html={t.forms.resource.privacyNotice.replace('{privacyPolicy}', `<a href="${getLocalizedPath('/privacy', lang)}" class="font-bold">${t.forms.resource.privacyPolicy}</a>`)}></p>
      </div>
    </form>
    <div id="resource-form-success" class="hidden text-center py-8">
      <h3 class="text-2xl font-bold mb-2">{t.forms.resource.successTitle}</h3>
      <p class="text-gray-600">{t.forms.resource.successMessage}</p>
    </div>
    <div id="resource-form-message" class="hidden text-center mt-4"></div>
  </div>

  {resource.content && (() => {
    // Clean up malformed checkmark patterns - catch ALL variations of $render with checkmark
    // Replace $render followed by any characters until checkmark (including backticks, quotes, escapes, HTML entities)
    const cleanedContent = resource.content
      .replace(/\$render[^✓]*✓[^<]*/g, '✓')
      .replace(/\$render[^✓]*✓[^<]*/g, '✓') // Run twice to catch nested patterns
      .replace(/`✓`/g, '✓')
      .replace(/\$render/g, '') // Remove any remaining $render without checkmark
      .replace(/\\`✓\\`/g, '✓')
      .replace(/\\`/g, '');
    
    const parsedContent = marked.parse(cleanedContent) as string;
    const processedContent = parsedContent
      // Replace any $render pattern with checkmark - multiple passes for reliability
      .replace(/\$render[^✓]*✓[^<]*/g, '✓')
      .replace(/\$render[^✓]*✓[^<]*/g, '✓') // Second pass
      // Handle HTML entities and encoded characters
      .replace(/\$render[^✓]*✓[^<]*/g, '✓')
      // Replace in any HTML tag content
      .replace(/>([^<]*)\$render[^✓]*✓[^<]*(<)/g, (match, before, after) => {
        return `>${before.replace(/\$render[^✓]*✓[^<]*/g, '✓')}${after}`;
      })
      // Handle list items specifically - more aggressive
      .replace(/<li([^>]*)>([^<]*)\$render[^✓]*✓[^<]*/gi, '<li$1>✓$2')
      .replace(/<li([^>]*)>([^<]*)\$render[^✓]*✓[^<]*/gi, '<li$1>✓$2') // Second pass
      // Remove any remaining $render
      .replace(/\$render/g, '')
      .replace(/<ol([^>]*)>/gi, '<ol$1 style="padding: 30px 30px 30px 80px !important; background-color: #f6f7fb !important; border-radius: 20px !important; list-style-position: outside !important;">')
      .replace(/<ul([^>]*)>/gi, '<ul$1 style="padding: 30px 30px 30px 80px !important; background-color: #f6f7fb !important; border-radius: 20px !important; list-style-position: outside !important;">');
    return (
      <div set:html={processedContent} />
    );
  })()}

  {resource.faqs && resource.faqs.length > 0 && (
    <div class="mt-12">
      <h2 class="text-3xl font-bold mb-6">Frequently Asked Questions</h2>
      <div class="space-y-4">
        {resource.faqs.map((faq: any) => (
          <div class="card">
            <h3 class="text-xl font-bold mb-2">{faq.question}</h3>
            <p class="text-black">{faq.answer}</p>
          </div>
        ))}
      </div>
    </div>
  )}

  {resource.citations && Array.isArray(resource.citations) && resource.citations.length > 0 && resource.citations.some(c => c && c.url) && (
    <div class="mt-12">
      <h2 class="text-3xl font-bold mb-6">Sources & References</h2>
      <div class="space-y-3">
        {resource.citations
          .filter(citation => citation && citation.url && citation.url.trim())
          .map((citation, index) => (
            <div class="border-l-4 border-gray-300 pl-4 py-2 hover:border-primary transition-colors">
              <a
                href={citation.url}
                target="_blank"
                rel="noopener noreferrer"
                class="text-primary hover:underline font-semibold block mb-1"
              >
                {citation.title || citation.url}
              </a>
              {citation.snippet && (
                <p class="text-sm text-gray-600 line-clamp-2">{citation.snippet}</p>
              )}
              <p class="text-xs text-gray-500 mt-1 break-all">{citation.url}</p>
            </div>
          ))}
      </div>
    </div>
  )}

  <!-- Resource Form (Bottom) -->
  <div class="card mb-8 p-8 md:p-12 mt-12" id="resource-form-bottom-container" style="min-height: 200px;">
    <form
      id="resource-form-bottom"
      name="resource form"
      class="grid md:grid-cols-2 gap-8 items-center"
    >
      <div>
        <h3 class="text-2xl font-bold mb-3">Boost your organization with Plademy solutions</h3>
        <p class="text-black">AI Powered Mentoring, Coaching, Community Management and Training Platforms</p>
      </div>
      <div class="space-y-4">
        <div>
          <input
            type="text"
            id="resource-form-bottom-name"
            name="name"
            placeholder="Full Name"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
          />
        </div>
        <div>
          <input
            type="email"
            id="resource-form-bottom-email"
            name="email"
            placeholder="Email"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-primary focus:border-transparent h-12"
          />
        </div>
        <button
          type="submit"
          class="btn btn-primary w-full"
        >
          Get Started For Free
        </button>
        <p class="text-[10px] text-gray-600 md:col-span-2" set:html={t.forms.resource.privacyNotice.replace('{privacyPolicy}', `<a href="${getLocalizedPath('/privacy', lang)}" class="font-bold">${t.forms.resource.privacyPolicy}</a>`)}></p>
      </div>
    </form>
    <div id="resource-form-bottom-success" class="hidden text-center py-8">
      <h3 class="text-2xl font-bold mb-2">{t.forms.resource.successTitle}</h3>
      <p class="text-gray-600">{t.forms.resource.successMessage}</p>
    </div>
    <div id="resource-form-bottom-message" class="hidden text-center mt-4"></div>
  </div>

  <div class="mt-8 pt-8 border-t">
    <a href="/resources/" class="text-primary hover:underline">
      ← {t.common.back} to Resources
    </a>
  </div>
</ContentLayout>

<script is:inline>
  (function() {
    // Handle first form (after keypoints)
    const form = document.getElementById('resource-form');
    const messageDiv = document.getElementById('resource-form-message');
    const successDiv = document.getElementById('resource-form-success');
    
    if (form && messageDiv && successDiv) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {
          type: 'resource form',
          name: formData.get('name'),
          email: formData.get('email'),
          resource_slug: window.location.pathname.split('/').pop() || '',
          resource_title: document.querySelector('h1')?.textContent || '',
          page_url: window.location.href,
        };
        
        try {
          const response = await fetch('/api/form', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          
          if (response.ok) {
            form.style.display = 'none';
            successDiv.classList.remove('hidden');
          } else {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            console.error('Form submission failed:', response.status, errorData);
            throw new Error(errorData.error || 'Form submission failed');
          }
        } catch (error) {
          console.error('Form error:', error);
          messageDiv.className = 'block text-red-600 font-semibold';
          messageDiv.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.';
        }
      });
    }

    // Handle bottom form
    const formBottom = document.getElementById('resource-form-bottom');
    const messageDivBottom = document.getElementById('resource-form-bottom-message');
    const successDivBottom = document.getElementById('resource-form-bottom-success');
    
    if (formBottom && messageDivBottom && successDivBottom) {
      formBottom.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(formBottom);
        const data = {
          type: 'resource form bottom',
          name: formData.get('name'),
          email: formData.get('email'),
          resource_slug: window.location.pathname.split('/').pop() || '',
          resource_title: document.querySelector('h1')?.textContent || '',
          page_url: window.location.href,
        };
        
        try {
          const response = await fetch('/api/form', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          
          if (response.ok) {
            formBottom.style.display = 'none';
            successDivBottom.classList.remove('hidden');
          } else {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            console.error('Form submission failed:', response.status, errorData);
            throw new Error(errorData.error || 'Form submission failed');
          }
        } catch (error) {
          console.error('Form error:', error);
          messageDivBottom.className = 'block text-red-600 font-semibold';
          messageDivBottom.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.';
        }
      });
    }
  })();
</script>
